### `main.py` and `main_registration_fields.py` â€” Complete Guide

---

## Table of Contents
1. [Introduction](#introduction)
2. [File Descriptions](#file-descriptions)
   - [Main File `main.py`](#main-file-mainpy)
   - [Module `main_registration_fields.py`](#module-main_registration_fieldspy)
3. [WireGuard Configuration Example](#wireguard-configuration-example)
4. [Using `main.py`](#using-mainpy)
   - [Execution Syntax](#execution-syntax)
   - [Command Line Parameters](#command-line-parameters)
   - [Execution Examples](#execution-examples)
5. [Configuration Files and Databases](#configuration-files-and-databases)

---

## Introduction

This project automates the management of VPN WireGuard users. The main file `main.py` handles user creation, configuration generation, adding users to the WireGuard server configuration, and metadata storage.

The `main_registration_fields.py` module standardizes user data entry and creates a unified record format.

---

## File Descriptions

### Main File `main.py`

`main.py` performs the following tasks:
1. Generates private, public, and pre-shared keys for a new user.
2. Assigns an IP address and creates a client configuration.
3. Generates a QR code for easy connection.
4. Adds the user to the WireGuard server configuration.
5. Creates or updates the user database with detailed information.
6. Restarts WireGuard to apply new settings.

#### Key Functions:
- **`generate_config()`**: Generates a new user configuration and QR code.
- **`restart_wireguard()`**: Restarts WireGuard to apply settings.
- **`load_existing_users()`**: Loads the current user database.
- **`is_user_in_server_config()`**: Checks if the user exists in the server configuration.
- **`add_user_record()`**: (Replaced with `create_user_record`) Adds a user record to the database.

---

### Module `main_registration_fields.py`

`main_registration_fields.py` contains the function `create_user_record`, which creates a standardized user record format. This record is used for database storage and VPN user management.

**The `create_user_record` function performs the following:**
- Generates a unique user identifier (UUID).
- Specifies account validity (30 days by default).
- Fills all required fields, including contact information, keys, IP address, referral data, subscription status, and more.

Example user record:
Here is a complete example of a user record generated by `create_user_record` in `main_registration_fields.py`, including descriptions of all fields and their usage.

---

## Full User Structure Description
# main_registration_fields.py
A user record generated by `create_user_record` looks like this:

```json
{
    "username": "JohnDoe",
    "user_id": "123e4567-e89b-12d3-a456-426614174000",
    "group": "guest",
    "tags": ["default-user"],
    "priority": 1,
    "created_at": "2024-11-27T12:00:00",
    "expires_at": "2024-12-27T12:00:00",
    "auto_suspend_date": "2024-12-27T12:00:00",
    "auto_delete_date": "2024-12-27T12:00:00",
    "last_config_update": "2024-11-27T12:00:00",
    "status": "active",
    "blocked_reason": "N/A",
    "renewal_requested": false,
    "allowed_ips": "192.168.1.2/32",
    "allowed_ips_custom": "192.168.1.2/32",
    "dns_custom": "1.1.1.1,8.8.8.8",
    "public_key": "public_key_example",
    "preshared_key": "preshared_key_example",
    "endpoint": "N/A",
    "last_handshake": "N/A",
    "uploaded": "N/A",
    "downloaded": "N/A",
    "transfer": "0.0 KiB received, 0.0 KiB sent",
    "total_transfer": "0.0 KiB",
    "data_limit": "100.0 GB",
    "data_used": "0.0 KiB",
    "qr_code_path": "/path/to/qr.png",
    "email": "john@example.com",
    "telegram_id": "123456789",
    "contact_method": "telegram",
    "subscription_plan": "free",
    "subscription_price": "0.00 USD",
    "payment_method": "N/A",
    "last_payment_date": "N/A",
    "next_payment_date": "N/A",
    "payment_status": "inactive",
    "total_spent": "0.00 USD",
    "auto_renew": false,
    "preferred_language": "en",
    "admin_notes": "N/A",
    "user_notes": "N/A",
    "ip_history": []
}
```

---

## Using `main.py`

### Execution Syntax

```bash
python3 main.py <nickname> [email] [telegram_id]
```

### Command Line Parameters

1. **`<nickname>`** (required): The new user's nickname, used as a unique identifier.
2. **`[email]`** (optional): The user's email address.
3. **`[telegram_id]`** (optional): The user's Telegram ID.

### Execution Examples

#### Creating a user with minimal data:
```bash
python3 main.py JohnDoe
```
*Result:*
- A user with the nickname `JohnDoe` will be created.
- The configuration file will be saved in `settings.WG_CONFIG_DIR`.
- The QR code will be saved in `settings.QR_CODE_DIR`.

#### Creating a user with additional data:
```bash
python3 main.py JohnDoe john@example.com 123456789
```
*Result:*
- The database will be updated with `email` and `telegram_id` information.

---

## Configuration Files and Databases

### User Database

- File: `user/data/user_records.json`
- Stores all user data in JSON format.
- The file is updated each time a user is added.

### Client Configurations

- Path: `settings.WG_CONFIG_DIR/<nickname>.conf`
- Contains the individual VPN configuration file for the client.

### QR Codes

- Path: `settings.QR_CODE_DIR/<nickname>.png`
- Contains the QR code for quick client setup.

---

## Notes

- All settings, such as configuration and QR code directories, are stored in `settings.py`.
- Script logs are displayed in the standard output and include message levels (`INFO`, `DEBUG`, `ERROR`).
- The script requires administrator privileges to modify WireGuard settings.

```bash
python3 main.py --help
# Run this command for help if such an option is added in the future.
